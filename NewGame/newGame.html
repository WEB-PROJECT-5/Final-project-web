<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Recycling Sokoban</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <div id="game-info">
        <div>Level: <span id="level">1</span></div>
        <div>Score: <span id="score">0</span></div>
        <div>Time: <span id="time">00:00</span></div>
    </div>
    <div id="game-container"></div>
    <div class="controls">
        <button onclick="restartLevel()">Restart Level</button>
        <button onclick="showHelp()">Help</button>
    </div>

    <script>
        // Cấu hình hình ảnh
        const SPRITES = {
            player: {
                right: 'asset/right.png', // Thay thế bằng URL sprite sheet nhân vật thực
                left: 'asset/left.png',
                front: 'asset/front.png',
                back: 'asset/back.png'
            },
            trash: {
                organic: 'asset/02-BananaSkin.png', // Thay thế bằng URL hình ảnh rác hữu cơ
                plastic: 'asset/08-Plastic.png', // Thay thế bằng URL hình ảnh rác nhựa
                paper: 'asset/16-Paper.png'    // Thay thế bằng URL hình ảnh rác giấy
            }
        };

        // Cấu hình game levels
        const LEVELS = [
            {
                map: [
                    "#####    ",
                    "#@  #    ",
                    "# OP# ###",
                    "# P # #p#",
                    "### ###o#",
                    " ##    p#",
                    " #   #  #",
                    " #   ####",
                    " #####   "
                ],
                timeLimit: 120,
                maxScore: 1000
            },
            {
                map: [
                    " ####   ",
                    " #  ### ",
                    " #@O  # ",
                    "### # ##",
                    "#p# #  #",
                    "#oP  # #",
                    "#o   O #",
                    "########"
                ],
                timeLimit: 180,
                maxScore: 2000
            },
            {
                map: [
                    "   #######   ",
                    "####     #   ",
                    "#   p### #   ",
                    "# # #    #   ",
                    "# # P O#o #  ",
                    "# #  pP # #  ",
                    "# o#O P # #  ",
                    "##    # # ###",
                    " # ###p    @#",
                    " #     ##   #",
                    " ############"
                ],
                timeLimit: 300,
                maxScore: 3000
            }
        ];

        let currentLevel = 0;
        let score = 0;
        let timer = null;
        let timeLeft = 0;
        let gameState = [];
        let playerPos = { x: 0, y: 0 };
        let playerDirection = 'right';
        let isMoving = false;
        let completedTrashCount = 0;
        let binPositions = [];

        function initGame() {
            preloadImages();
            initLevel();

        }

        function preloadImages() {
            Object.values(SPRITES.player).forEach(url => {
                const img = new Image();
                img.src = url;

            });
            Object.values(SPRITES.trash).forEach(url => {
                const img = new Image();
                img.src = url;

            });

        }

        function initLevel() {
            gameState = LEVELS[currentLevel].map.map(row => row.split(''));
            playerPos = findPlayer();
            timeLeft = LEVELS[currentLevel].timeLimit;
            completedTrashCount = 0;

            // Lưu vị trí các thùng rác
            binPositions = [];
            for (let y = 0; y < gameState.length; y++) {
                for (let x = 0; x < gameState[y].length; x++) {
                    if (gameState[y][x] === 'o' || gameState[y][x] === 'p') {
                        binPositions.push({ x, y, type: gameState[y][x] });
                    }
                }
            }

            if (timer) {
                clearInterval(timer);
            }
            timer = setInterval(updateTimer, 1000);
            updateDisplay();
        }


        function findPlayer() {
            for (let y = 0; y < gameState.length; y++) {
                for (let x = 0; x < gameState[y].length; x++) {
                    if (gameState[y][x] === '@') {
                        return { x, y };

                    }

                }

            }
            return { x: 0, y: 0 };

        }
        function getBinAtPosition(x, y) {
            return binPositions.find(bin => bin.x === x && bin.y === y);
        }

        function updateDisplay() {
            const container = document.getElementById('game-container');
            container.innerHTML = '';

            gameState.forEach((row, y) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';

                row.forEach((cell, x) => {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'cell';

                    // Kiểm tra thùng rác tại vị trí hiện tại
                    const bin = getBinAtPosition(x, y);

                    // Hiển thị thùng rác trước
                    if (bin) {
                        cellDiv.classList.add(bin.type === 'o' ? 'bin-organic' : 'bin-plastic');
                    }

                    // Sau đó hiển thị các đối tượng khác
                    switch (cell) {
                        case '#':
                            cellDiv.classList.add('wall');
                            break;
                        case '@':
                            renderPlayer(cellDiv, playerDirection);
                            break;
                        case 'O':
                            renderTrash(cellDiv, 'organic');
                            break;
                        case 'P':
                            renderTrash(cellDiv, 'plastic');
                            break;
                        case 'o':
                        case 'p':
                            // Thùng rác đã được thêm ở trên
                            break;
                    }

                    rowDiv.appendChild(cellDiv);
                });
                container.appendChild(rowDiv);
            });

            document.getElementById('level').innerText = currentLevel + 1;
            document.getElementById('score').innerText = score;
            document.getElementById('time').innerText = formatTime(timeLeft);
        }

        function renderPlayer(cellDiv, direction) {
            cellDiv.classList.add('player');
            cellDiv.style.backgroundImage = direction === 'right' ? `url(${SPRITES.player.right})` : `url(${SPRITES.player.left})`;

        }

        function renderTrash(cellDiv, type) {
            cellDiv.classList.add('trash');
            cellDiv.style.backgroundImage = `url(${SPRITES.trash[type]})`;

        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;

        }

        function updateTimer() {
            if (timeLeft > 0) {
                timeLeft--;
                updateDisplay();
            } else {
                alert("Hết thời gian!");
                clearInterval(timer);
                initLevel();
            }
        }

        function movePlayer(dx, dy) {
            if (isMoving) return;
            isMoving = true;

            const newX = playerPos.x + dx;
            const newY = playerPos.y + dy;

            if (isWall(newX, newY)) {
                isMoving = false;
                return;
            }

            if (isTrash(newX, newY)) {
                const newTrashX = newX + dx;
                const newTrashY = newY + dy;

                if (isWall(newTrashX, newTrashY) || isTrash(newTrashX, newTrashY)) {
                    isMoving = false;
                    return;
                }

                // Lấy loại rác và vị trí thùng rác
                const trashType = gameState[newY][newX];
                const bin = getBinAtPosition(newTrashX, newTrashY);

                // Lưu trạng thái ô hiện tại của rác (có thể là thùng rác)
                const currentBin = getBinAtPosition(newY, newX);

                // Di chuyển rác
                gameState[newY][newX] = currentBin ? currentBin.type : ' ';
                gameState[newTrashY][newTrashX] = trashType;

                // Tính điểm nếu rác được đẩy vào đúng thùng
                if (bin && isCorrectBin(trashType, bin.type)) {
                    score += 100;
                }
            }

            // Di chuyển người chơi
            const currentBin = getBinAtPosition(playerPos.x, playerPos.y);
            gameState[playerPos.y][playerPos.x] = currentBin ? currentBin.type : ' ';
            playerPos.x = newX;
            playerPos.y = newY;
            gameState[playerPos.y][playerPos.x] = '@';

            playerDirection = dx > 0 ? 'right' : 'left';
            updateDisplay();
            isMoving = false;
            checkWinCondition();
        }

        function isCorrectBin(trashType, binType) {
            return (trashType === 'O' && binType === 'o') ||
                (trashType === 'P' && binType === 'p');
        }

        function getTrashCount() {
            return gameState.flat().filter(cell => cell === 'O' || cell === 'P').length;
        }

        function isWall(x, y) {
            return gameState[y] && gameState[y][x] === '#';
        }

        function isTrash(x, y) {
            return gameState[y] && ['O', 'P'].includes(gameState[y][x]);
        }

        function restartLevel() {
            initLevel();
        }

        function checkWinCondition() {
            let allTrashInCorrectBins = true;
            let foundTrash = false;

            for (let y = 0; y < gameState.length; y++) {
                for (let x = 0; x < gameState[y].length; x++) {
                    if (gameState[y][x] === 'O' || gameState[y][x] === 'P') {
                        foundTrash = true;
                        const bin = getBinAtPosition(x, y);
                        if (!bin || !isCorrectBin(gameState[y][x], bin.type)) {
                            allTrashInCorrectBins = false;
                            break;
                        }
                    }
                }
                if (!allTrashInCorrectBins) break;
            }

            if (foundTrash && allTrashInCorrectBins) {
                alert("Chúc mừng! Bạn đã hoàn thành cấp độ này!");
                nextLevel();
            }
        }


        function nextLevel() {
            currentLevel++;
            if (currentLevel < LEVELS.length) {
                initLevel();
            } else {
                alert("Bạn đã hoàn thành tất cả các cấp độ!");
                currentLevel = 0;
                initLevel();
            }
        }

        document.addEventListener('keydown', (event) => {
            switch (event.key) {
                case 'ArrowUp':
                    movePlayer(0, -1);
                    break;
                case 'ArrowDown':
                    movePlayer(0, 1);
                    break;
                case 'ArrowLeft':
                    movePlayer(-1, 0);
                    break;
                case 'ArrowRight':
                    movePlayer(1, 0);
                    break;
            }
        });

        function showHelp() {
            alert("Cách chơi: Sử dụng các phím mũi tên để di chuyển nhân vật và đặt rác vào thùng đúng loại.");
        }

        window.onload = initGame;
    </script>
</body>

</html>